name: rag-education-assistant-prod

services:
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway.prod
    container_name: api-gateway-prod
    ports:
      - "${API_GATEWAY_PORT:-8000}:8000"
    environment:
      # Port configuration
      - PORT=8000
      - API_GATEWAY_PORT=8000
      - HOST=0.0.0.0
      # Service URLs - Internal Docker network
      - PDF_PROCESSOR_URL=http://docstrange-service:80
      - DOCUMENT_PROCESSOR_HOST=document-processing-service
      - DOCUMENT_PROCESSOR_PORT=8080
      - DOCUMENT_PROCESSOR_URL=http://document-processing-service:8080
      - MODEL_INFERENCE_HOST=model-inference-service
      - MODEL_INFERENCE_PORT=8002
      - MODEL_INFERENCE_URL=http://model-inference-service:8002
      - RAG_EVALUATOR_URL=http://rag-evaluator-service:8005
      - CHROMADB_HOST=chromadb-service
      - CHROMADB_PORT=8000
      - CHROMADB_URL=http://chromadb-service:8000
      - DOCSTRANGE_URL=http://docstrange-service:80
      - MARKER_API_HOST=marker-api
      - MARKER_API_PORT=8090
      - MARKER_API_URL=http://marker-api:8090
      - AUTH_SERVICE_HOST=auth-service
      - AUTH_SERVICE_PORT=8006
      - AUTH_SERVICE_URL=http://auth-service:8006
      - APRAG_SERVICE_HOST=aprag-service
      - APRAG_SERVICE_PORT=8007
      - APRAG_SERVICE_URL=http://aprag-service:8007
      # Database configuration
      - DATABASE_PATH=/app/data/rag_assistant.db
      # JWT configuration - MUST be set in .env
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      # CORS configuration - Update with your Hetzner server IP/domain
      - CORS_ORIGINS=${CORS_ORIGINS}
      - CORS_CREDENTIALS=true
    volumes:
      - session_data:/app/sessions
      - markdown_data:/app/data/markdown
      - database_data:/app/data
    command: python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --workers 5
    depends_on:
      auth-service:
        condition: service_healthy
      docstrange-service:
        condition: service_started
      document-processing-service:
        condition: service_started
      model-inference-service:
        condition: service_started
      reranker-service:
        condition: service_started
      chromadb-service:
        condition: service_started
      aprag-service:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 512M

  aprag-service:
    build:
      context: ./services/aprag_service
      dockerfile: Dockerfile
    container_name: aprag-service-prod
    ports:
      - "${APRAG_SERVICE_PORT:-8007}:8007"
    environment:
      - HOST=0.0.0.0
      - PORT=8007
      - APRAG_SERVICE_PORT=8007
      - MODEL_INFERENCE_HOST=model-inference-service
      - MODEL_INFERENCE_PORT=8002
      - MODEL_INFERENCE_URL=http://model-inference-service:8002
      - MODEL_INFERENCER_URL=http://model-inference-service:8002
      - RERANKER_SERVICE_HOST=reranker-service
      - RERANKER_SERVICE_PORT=8008
      - RERANKER_SERVICE_URL=http://reranker-service:8008
      - USE_RERANKER_SERVICE=true
      - CHROMADB_HOST=chromadb-service
      - CHROMADB_PORT=8000
      - CHROMADB_URL=http://chromadb-service:8000
      - CHROMA_SERVICE_URL=http://chromadb-service:8000
      - DOCUMENT_PROCESSING_HOST=document-processing-service
      - DOCUMENT_PROCESSING_PORT=8080
      - DOCUMENT_PROCESSING_URL=http://document-processing-service:8080
      - DATABASE_PATH=/app/data/rag_assistant.db
      - APRAG_DB_PATH=/app/data/rag_assistant.db
      - DEFAULT_EMBEDDING_MODEL=${DEFAULT_EMBEDDING_MODEL:-text-embedding-v4}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - CORS_CREDENTIALS=true
      - APRAG_ENABLED=true
      - APRAG_FEEDBACK_COLLECTION=true
      - APRAG_PERSONALIZATION=true
      - APRAG_RECOMMENDATIONS=true
      - APRAG_ANALYTICS=true
    volumes:
      - database_data:/app/data
      - ./services/auth_service/database/migrations:/app/migrations:ro
    command: python -m uvicorn main:app --host 0.0.0.0 --port 8007 --workers 3
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8007/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      auth-service:
        condition: service_healthy
      model-inference-service:
        condition: service_started
      chromadb-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 512M

  auth-service:
    build:
      context: ./services/auth_service
      dockerfile: Dockerfile
    container_name: auth-service-prod
    ports:
      - "${AUTH_SERVICE_PORT:-8006}:8006"
    environment:
      - HOST=0.0.0.0
      - PORT=8006
      - AUTH_SERVICE_PORT=8006
      - DEBUG=false
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - REFRESH_TOKEN_EXPIRE_DAYS=7
      - DATABASE_PATH=/app/data/rag_assistant.db
      - CORS_ORIGINS=${CORS_ORIGINS}
      - CORS_CREDENTIALS=true
      - RATE_LIMIT_RPM=300
      - RATE_LIMIT_BURST=50
      - REQUIRE_AUTH=true
    volumes:
      - database_data:/app/data
      - ./src/database:/app/src_database
      - ./services/auth_service/create_test_user.py:/app/create_test_user.py
      - ./services/auth_service/reset_admin_password.py:/app/reset_admin_password.py
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8006/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    command: >
      sh -c "/app/init-db.sh &&
             python -m uvicorn main:app --host 0.0.0.0 --port 8006 --workers 3"
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          memory: 256M

  docstrange-service:
    build:
      context: ./services/docstrange_service
      dockerfile: Dockerfile
    container_name: docstrange-service-prod
    ports:
      - "${DOCSTRANGE_PORT:-8005}:80"
    environment:
      - DOCSTRANGE_API_KEY=${DOCSTRANGE_API_KEY}
    restart: unless-stopped
    networks:
      - rag-network

  document-processing-service:
    build:
      context: .
      dockerfile: services/document_processing_service/Dockerfile
    container_name: document-processing-service-prod
    ports:
      - "${DOCUMENT_PROCESSOR_PORT:-8003}:8080"
    environment:
      - MODEL_INFERENCER_HOST=model-inference-service
      - MODEL_INFERENCER_PORT=8002
      - MODEL_INFERENCER_URL=http://model-inference-service:8002
      - RERANKER_SERVICE_HOST=reranker-service
      - RERANKER_SERVICE_PORT=8008
      - RERANKER_SERVICE_URL=http://reranker-service:8008
      - USE_RERANKER_SERVICE=true
      - RERANKER_TYPE=${RERANKER_TYPE:-alibaba}
      - ALIBABA_API_KEY=${ALIBABA_API_KEY:-${DASHSCOPE_API_KEY}}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - CHROMADB_HOST=chromadb-service
      - CHROMADB_PORT=8000
      - CHROMADB_URL=http://chromadb-service:8000
      - CHROMA_SERVICE_URL=http://chromadb-service:8000
      - GROQ_API_KEY=${GROQ_API_KEY}
    volumes:
      - session_data:/app/sessions
    command: python -m uvicorn main_new:app --host 0.0.0.0 --port 8080 --workers 4
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          memory: 1G

  model-inference-service:
    build:
      context: ./services/model_inference_service
      dockerfile: Dockerfile.prod
    container_name: model-inference-service-prod
    ports:
      - "${MODEL_INFERENCE_PORT:-8002}:8002"
    environment:
      - PORT=8002
      - MODEL_INFERENCE_PORT=8002
      - GROQ_API_KEY=${GROQ_API_KEY}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ALIBABA_API_KEY=${ALIBABA_API_KEY:-${DASHSCOPE_API_KEY}}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - ALIBABA_API_BASE=${ALIBABA_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      # Use Ollama service in Docker network
      - OLLAMA_HOST=http://ollama-service:11434
      - OLLAMA_SKIP_VERIFY=true
    depends_on:
      ollama-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 512M

  ollama-service:
    image: ollama/ollama:latest
    container_name: ollama-service-prod
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  reranker-service:
    build:
      context: ./services/reranker_service
      dockerfile: Dockerfile
    container_name: reranker-service-prod
    ports:
      - "${RERANKER_SERVICE_PORT:-8008}:8008"
    environment:
      - PORT=8008
      - RERANKER_TYPE=${RERANKER_TYPE:-alibaba}
      - ALIBABA_API_KEY=${ALIBABA_API_KEY:-${DASHSCOPE_API_KEY}}
      - BGE_MODEL_NAME=${BGE_MODEL_NAME:-BAAI/bge-reranker-v2-m3}
      - MS_MARCO_MODEL_NAME=${MS_MARCO_MODEL_NAME:-cross-encoder/ms-marco-MiniLM-L-6-v2}
      - HF_HOME=/app/models
      - TRANSFORMERS_CACHE=/app/models
    volumes:
      - reranker_models:/app/models
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          memory: 512M

  chromadb-service:
    image: chromadb/chroma:1.3.0
    container_name: chromadb-service-prod
    ports:
      - "${CHROMADB_PORT:-8004}:8000"
    volumes:
      - chroma_data:/data
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/data
      - ANONYMIZED_TELEMETRY=false
      - ALLOW_RESET=true
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          memory: 512M

  marker-api:
    image: wirawan/marker-api:latest
    container_name: marker-api-prod
    ports:
      - "${MARKER_API_PORT:-8090}:8080"
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          memory: 512M

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_AUTH_URL: ${NEXT_PUBLIC_AUTH_URL}
        NEXT_PUBLIC_AUTH_ENABLED: ${NEXT_PUBLIC_AUTH_ENABLED:-true}
        NEXT_PUBLIC_DEMO_MODE: ${NEXT_PUBLIC_DEMO_MODE:-false}
    container_name: rag3-frontend-prod
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - PORT=3000
      - FRONTEND_PORT=3000
      - API_GATEWAY_HOST=api-gateway
      - API_GATEWAY_PORT=8000
      - API_GATEWAY_INTERNAL_PORT=8000
      # Update with your Hetzner server IP or domain
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_AUTH_URL=${NEXT_PUBLIC_AUTH_URL}
      - API_GATEWAY_INTERNAL_URL=http://api-gateway:8000
      - AUTH_SERVICE_INTERNAL_URL=http://auth-service:8006
      - NODE_ENV=production
      - DOCKER_ENV=true
      - NEXT_PUBLIC_AUTH_ENABLED=${NEXT_PUBLIC_AUTH_ENABLED:-true}
      - NEXT_PUBLIC_DEMO_MODE=${NEXT_PUBLIC_DEMO_MODE:-false}
      - CORS_ORIGINS=${CORS_ORIGINS}
    depends_on:
      api-gateway:
        condition: service_started
      auth-service:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          memory: 256M

volumes:
  ollama_data:
  chroma_data:
  session_data:
  markdown_data:
  database_data:
  reranker_models:

networks:
  rag-network:
    name: rag-education-assistant-prod_rag-network
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "true"
    ipam:
      config:
        - subnet: 172.18.0.0/16

